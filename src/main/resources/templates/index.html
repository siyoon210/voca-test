<!DOCTYPE html>
<!--[if lt IE 7]>
<html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en" class="no-js"> <!--<![endif]-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>단어 테스트</title>

    <!-- jQuery -->
    <script src="../static/js/jquery.min.js"></script>
    <!-- jsRender -->
    <script src="../static/js/jsrender.min.js"></script>
    <!-- jsViews -->
    <script src="../static/js/jsviews.min.js"></script>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,300' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/animate.css">
    <link rel="stylesheet" href="../static/css/style.css">


    <!-- Modernizr JS -->
    <script src="../static/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="../static/js/respond.min.js"></script>
    <![endif]-->
</head>
<style>
    @media (max-width: 700px) {
        .voca-text {
            font-size: 4.5em;
        }
    }

    @media (min-width: 700px) {
        .voca-text {
            font-size: 5em;
        }
    }

    @media (min-width: 800px) {
        .voca-text {
            font-size: 6em;
        }
    }
</style>

<body class="container"></body>

<script>
    (function () {
        const newVocaSound = new Audio('../static/sound/ARROW.WAV');
        const domain = "http://localhost:8080";

        const data = {
            bookId: 1,
            start: null,
            end: null,
            includeDerivative: false,
            size: undefined,
            vocaList: [],
            progress: {
                index: 0,
                english : null
            }
        };

        const eventHandlers = {
            requestData: function () {
                data.start = $('#start').val();
                data.end = $('#end').val();
                data.includeDerivative = $('#derivative').prop('checked');

                const url = function () {
                    let url = domain + '/api/books/' + data.bookId + '/vocas'
                        + '?start=' + data.start + '&end=' + data.end;

                    if (data.includeDerivative) {
                        url += '&derivative=true';
                    }

                    return url;
                }();

                $.get(url)
                    .done(function (res) {
                        data.vocaList = res;
                        window.location.hash = '#ready';
                    })
                    .fail(function (res) {
                        console.log('ERROR', res);
                    });
            },
            startTest: function () {
                $('#start-btn').hide();

                delayBeforeTest()
                    .then(slideVocas);

                function delayBeforeTest() {
                    return new Promise(function (resolve) {
                        setTimeout(function () {
                            resolve();
                        }, 1000)
                    });
                }

                function slideVocas() {
                    newVocaSound.play().then();
                    $.observable(data).setProperty('progress.english', data.vocaList[data.progress.index].english);
                    window.location.hash = '#progress';

                    const testInterval = setInterval(function () {
                        if (data.progress.index >= data.vocaList.length || location.hash !== '#progress') {
                            clearInterval(testInterval);
                            data.progress.index = 0;
                            return;
                        }
                        newVocaSound.play().then();
                        data.progress.index++;
                        $.observable(data).setProperty('progress', {
                            index: data.progress.index,
                            english: data.vocaList[data.progress.index].english
                        });
                    }, 1000);
                }
            }
        };

        function render(template) {
            $.templates(template).link('body', data, eventHandlers);
        }

        function get(url) {
            return new Promise(function (resolve, reject) {
                $.get(url, function (response) {
                    resolve(response);
                    reject(response);
                });
            });
        }

        const routes = {
            '': function () {
                get('range-select.html')
                    .then(template => render(template));
            },
            'ready': function () {
                get('ready.html')
                    .then(template => render(template));
            },
            'progress': function () {
                get('progress.html')
                    .then(template => render(template));
            },
            otherwise() {
                root.innerHTML = `${location.hash} Not Found`;
            }
        };

        function router() {
            const hash = location.hash.replace('#', '');
            (routes[hash] || routes.otherwise)();
        }

        $(window).bind('hashchange', router);
        $(window).bind('DOMContentLoaded', router);
    }());
</script>

<!-- Bootstrap -->
<script src="../static/js/bootstrap.min.js"></script>
<!-- Placeholder -->
<script src="../static/js/jquery.placeholder.min.js"></script>
<!-- Waypoints -->
<script src="../static/js/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="../static/js/main.js"></script>

</html>